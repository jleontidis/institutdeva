
var deva = angular.module('devaApp',['ngRoute','ngSanitize','ngResource','textAngular','720kb.datepicker','uiGmapgoogle-maps']);


deva.directive('myModal', function() {
   return {
     restrict: 'A',
     link: function(scope, element, attr) {
       scope.dismiss = function() {
           element.modal('hide');
       };
     }
   }; 
});
deva.config(['$routeProvider','$provide',function($routeProvider,$provide){
    
    $routeProvider
        .when('/home', {templateUrl:'html/home.html'})
        .when('/quis-suis-je',  {templateUrl:'html/quisuisje.html'})
        .when('/cours',  {controller:'coursesCRUDCtrl',templateUrl:'html/cours.html'})
        .when('/messoins',  {templateUrl:'html/nosoins.html'})
        .when('/contact',  {controller:'contactCtrl',templateUrl:'html/contact.html'})
        .when('/gestion/cours', {controller:'coursesCRUDCtrl',templateUrl:'html/gestion/cours.html'})
        .when('/gestion/login', {controller:'loginCtrl', templateUrl:'html/gestion/login.html'})
        .otherwise({redirectTo: '/home'});
    
    $provide.decorator('taOptions', ['$delegate', function(taOptions) { // $delegate is the taOptions we are decorating
                    

    taOptions.toolbar = [
      ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'pre', 'quote'],
      ['bold', 'italics', 'underline', 'strikeThrough', 'ul', 'ol', 'redo', 'undo', 'clear'],
      ['justifyLeft', 'justifyCenter', 'justifyRight', 'indent', 'outdent'],
      ['insertLink']
  ];
        
        return taOptions;
        
    }]);

}]);
deva.factory('sendEmailFactory', ['$http',function($http){
	var url = 'api/json.api?www-command=users-sendemail';
	return {
		sendEmail: function(person) {
		return $http.post(url, person);
		}
		};
	
}]);

deva.factory('userAuthFactory', ['$http', function($http){
	var url = 'api/json.api?www-command=';
	
	return {
	checkLogin: function(user) {
	return $http.post(url+"users-checklogin", user);
	},
	logout: function() {
	return $http.get(url+"users-logout");
	},
	getUser: function()
	{
		return $http.get(url+"users-get");
	}
	};
	}]);


deva.factory('courseFactory', function ($http) {
	var url = 'api/json.api?www-command=';

    return {
        getCourses: function () {
            return $http.get(url+"courses-all");
        },
        addCourse: function (course) {
            return $http.post(url+"courses-add", course);
        },
        deleteCourse: function (course) {
            return $http.delete(url+"courses-delete&id="+course.id);
        },
        updateCourse: function (course) {
            return $http.put(url+"courses-update&id=" + course.id, course);
        }
    };
});
deva.controller('menuCtrl',['$scope','$location',function($scope,$location){
    
    $scope.isRouteActive = function(route){
        
        var curRoute = $location.path();
        return curRoute.match(route);
    };
    
}]);


//TO DO 
deva.controller('userAuthCtrl', ['$scope','$location','$rootScope','userAuthFactory',function($scope,$location,$rootScope,userAuthFactory){
    
   
    userAuthFactory.getUser().success(function(result){
        
        $scope.userIsLoggedIn = result.success;
   
        console.log(result.success);
        $rootScope.$on('$locationChangeSuccess', function(event){
        
        var url = $location.url();
        console.log($scope.userIsLoggedIn);
        if($scope.userIsLoggedIn)
        {
            console.log($scope.userIsLoggedIn);
            $scope.userIsLoggedIn = true;
        }

    });
    
    });
    
      
}]);

deva.controller("loginCtrl", ['$scope','userAuthFactory','$location','$route',function($scope,userAuthFactory,$location,$route) {
	
		$scope.loginCredentials = [];
		    
	     $scope.submit = function () {
		    	userAuthFactory.checkLogin($scope.user)
                    .success(function(result){
                    if(result.error)
                    {
                        console.log("Hello" + result.error);
                    }
                    else
                    {
                        console.log("Hello" + result.error);
                        $location.path('/gestion/cours');
                        $route.reload();
                    }
		    	     })
                    .error(function(result,status){
                    
                        console.log(result);
                    
                });
		    };
}]);

deva.controller('coursesCRUDCtrl',['$scope','$location','courseFactory','userAuthFactory', function($scope,$location,courseFactory,userAuthFactory){
   
   $scope.editMode = false;
   
   $scope.clearForm = function()
   {
        $scope.newcourse = {};
        $scope.newcourse.title = '';
        $scope.newcourse.date = '';
        $scope.newcourse.description = ''; 
        $scope.editMode = false;
   };
    
    var getCourseData = function(){
        
        return courseFactory.getCourses()
        .success(function(result){
        
        $scope.courses = result;
        $scope.clearForm();

    })
        .error(function(data,status){
       
        console.log(data);
    });
    };
    
    getCourseData();  
    $scope.clearForm();
   
    
    
    $scope.addCourse = function()
    {
        var date = new Date();
        $scope.insertTitle = "Veuillez insérer un titre.";
        $scope.showTitleError = false;
        $scope.insertDescription = "Veuillez insérer une description.";
        $scope.showDescriptionError = false;
        
        $scope.revealTitleError = function()
        {
            $scope.showTitleError = true;
        };
        
        $scope.revealDescriptionError = function()
        {
            $scope.showDescriptionError = true;
        };
        
        if(($scope.newcourse.title !== "") && ($scope.newcourse.description !== ""))
        {
            $scope.newcourse.created = date;
            courseFactory.addCourse($scope.newcourse)
           .success(function(result){

               $scope.courses = result;
               $scope.clearForm();
               date = '';
               $scope.showTitleError = false;
               $scope.showDescriptionError = false;
               getCourseData();
               $scope.dismiss();

           })
           .error(function(data,status){

               console.log(data);
           });
       }
       else if($scope.newcourse.title === "")
       {
           $scope.revealTitleError();
       }
       else if($scope.newcourse.description === "")
       {
           $scope.revealDescriptionError();
       }
       else
       {
           $scope.revealTitleError();
           $scope.revealDescriptionError();
       }
    };
    
    $scope.editCourse = function(course){
      
        $scope.editMode = true;
        $scope.newcourse.title = course.title;
        $scope.newcourse.date = course.date;
        $scope.newcourse.description = course.description;
        $scope.newcourse.id = course.id;
        $scope.newcourse.created = course.created;
        console.log($scope.newcourse);
    };
    
    $scope.updateCourse = function()
    {
              
        courseFactory.updateCourse($scope.newcourse)
        .success(function(result){
            $scope.courses = result;
            $scope.clearForm();
            $scope.dismiss();
            getCourseData();
            $scope.editMode = false;
            
        })
        .error(function(data,status){
            
            console.log(data);
        });
        
    };
    
    $scope.deleteCourse = function(course)
    {
        var deleteC = confirm('Êtes-vous sur de vouloir supprimer ce cours?');   
       
    	if (deleteC) 
        {
        	courseFactory.deleteCourse(course)
                .success(function(result){
                
                $scope.courses = result;
                getCourseData();
                
            }).error(function(data,status){
            
            console.log(data);
        });
        }
        
    };
    
    
    $scope.logout = function()
    {
        userAuthFactory.logout();
        $location.path('gestion/login');
    };
}]);

deva.controller('contactCtrl',['$scope','uiGmapGoogleMapApi', function($scope,uiGmapGoogleMapApi){

    uiGmapGoogleMapApi.then(function(map){
    
      //var boxText = {};
      //boxText.style.cssText = "border: 1px solid black; ";

      var output = '<div id="mapInfo" >'+
      '<div class="col-xs-12">' +
      '<img src="img/logo.png" alt="Logo" class="img-responsive"/>' +
      '<div>' +
      '<p class="address">' +
      '<br>' +
      'Rue Baptiste-Savoye 36<br>' +
      'CH-2610 Saint-Imier<br>' +
      ' Suisse </p><br>' +
      '<p class="address">' +
      '<i class="fa fa-phone"></i>&nbsp;&nbsp;<span>t&eacute;l : 079 543 68 07</span><br>' +
      '<i class="fa fa-envelope"></i><span>&nbsp;<a href="mailto:info@institutdeva.ch" onmouseover="this.href=this.href.replace(/x/g,\'\');">info@institutdeva.ch</a></span> </p> </div> </div></div>';     

      //boxText.innerHTML = output;
    
    
    $scope.show = true;
    $scope.coords = {
        latitude: 47.1504355,
        longitude: 6.9930737
    };

    $scope.windowOptions = {
        boxClass: "infobox",
        boxStyle: {
            border: "1px solid #6A3488",
            borderRadius: "5px",
            background: "#FFF",
            opacity: 1,
            width: "200px",
            textAlign:"center"
        },
        content: output,
        pane: "floatPane",
        enableEventPropagation: false
    };

    $scope.mapOptions = {
        center: {
            latitude: 47.1504355,
            longitude: 6.9930737
        },
        zoom: 17
    };
});
    
}]);

deva.controller("emailCtrl", ['$scope','sendEmailFactory',function ($scope,sendEmailFactory) {
	
	 $scope.messageSuccess = false;
	 $scope.emptyForm = false;
	 $scope.novalidForm = false;
	 $scope.submitted = false;
	 $scope.email = function () {
		 
		 if ($scope.emailForm.$valid) {
			 sendEmailFactory.sendEmail($scope.person)
	    		.success(function(){
	    			$scope.messageSuccess = false;
	    			$scope.person = {};
	    			$scope.messageSuccess = true;
	    			 $scope.emptyForm = false;
	    			 $scope.novalidForm = false;
	    		})
	    		.error(function(){ 
	    			console.log("Email not send");});
		    } else {
		    	$scope.messageSuccess = false;
		      if($scope.person === null)
		      {
		    	  $scope.emptyForm = true;
		    	  $scope.errorMessage = "Aucun champ n'a été rempli!";
		    	  $scope.emailForm.submitted = false;
		      }
		      else
		      {
		    	  $scope.messageSuccess = false;
		    	  $scope.emailForm.submitted = true;
		    	  $scope.emptyForm = true;
		    	  $scope.errorMessage = "Merci de vérifiez que vous avez entré votre nom, votre email et votre message.";
		      }
		    }
	    	
	    };
	
}]);
$(document).ready(function(){
	var d = new Date();
	var x = document.getElementById("currentYear");
	x.innerHTML = d.getFullYear();

		
		// Start slide animation
		$("#carousel-example-generic").on('slide.bs.carousel', function(event){
			
				$(".caption-item h2").css({left:"-3%", opacity:"0"});
				$(".caption-item h3").css({left:"-3%", opacity:"0"});
				$(".caption-item p").css({left:"-3%", opacity:"0"});
				$(".caption-image.image-right img").css({right:"-5%", opacity:"0"});
				$(".caption-image.image-left img").css({left:"-3%", opacity:"0"});
			
		});
		
		$("#carousel-example-generic").on('slid.bs.carousel', function(event){
			
				$(".caption-item h2 ").css({left:"0", opacity:"1"});
				$(".caption-item h3 ").css({left:"0", opacity:"1"});
				$(".caption-item p ").css({left:"0", opacity:"1"});
				$(".caption-image.image-right img").css({right:"0", opacity:"1"});
				$(".caption-image.image-left img").css({left:"0", opacity:"1"});
			
			});
		
		$('#bs-example-navbar-collapse-1').on('show.bs.collapse', function () {
			 
			$('#carousel-example-generic').hide();
			});
		
		$('#bs-example-navbar-collapse-1').on('hidden.bs.collapse', function () {
			 
			$('#carousel-example-generic').show();
			});
});